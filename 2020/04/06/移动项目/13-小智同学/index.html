<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="姑姑">
    <meta name="keyword" content="">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="测试顺带笔记" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        移动项目/13-小智同学｜undefined
        
    </title>

    <link rel="canonical" href="http://yoursite.com/2020/04/06/移动项目/13-小智同学/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/blog-style.css">


    <!-- Pygments Github CSS -->
    
<link rel="stylesheet" href="/css/syntax.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<style>

    header.intro-header {
        background-image: url('')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    测试顺带笔记
                </span>
                's Blog
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
					
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="">


<style>
    
    header.intro-header {
        background-image: url('')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>移动项目/13-小智同学</h1>
                    
                    <span class="meta">
                         作者 摸鱼侠
                        <span>
                          日期 2020-04-06
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            移动项目/13-小智同学
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <h1 id="十三、小智同学"><a href="#十三、小智同学" class="headerlink" title="十三、小智同学"></a>十三、小智同学</h1><img src="./assets/1566431856572.png" width="300">

<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p><img src="./assets/bg2017051501.png" alt="img"></p>
<ul>
<li>WebSocket 是一种数据通信协议，类似于我们常见的 http</li>
<li>既然有 http，为啥还要 WebSocket</li>
<li>http 通信是单向的<ul>
<li>请求 + 响应</li>
<li>没有请求也就没有响应</li>
</ul>
</li>
</ul>
<p>初次接触 WebSocket 的人，都会问同样的问题：我们已经有了 HTTP 协议，为什么还需要另一个协议？它能带来什么好处？</p>
<p>答案很简单，因为 HTTP 协议有一个缺陷：通信只能由客户端发起。</p>
<p>举例来说，我们想了解今天的天气，只能是客户端向服务器发出请求，服务器返回查询结果。HTTP 协议做不到服务器主动向客户端推送信息。</p>
<p>这种单向请求的特点，注定了如果服务器有连续的状态变化，客户端要获知就非常麻烦。我们只能使用<a href="https://www.pubnub.com/blog/2014-12-01-http-long-polling/" target="_blank" rel="noopener">“轮询”</a>：每隔一段时候，就发出一个询问，了解服务器有没有新的信息。最典型的场景就是聊天室。</p>
<p>轮询的效率低，非常浪费资源（因为必须不停连接，或者 HTTP 连接始终打开）。因此，工程师们一直在思考，有没有更好的方法。WebSocket 就是这样发明的。</p>
<p>WebSocket 协议在 2008 年诞生，2011 年成为国际标准。所有浏览器都已经支持了。</p>
<p>它的最大特点就是，<strong>服务器可以主动向客户端推送信息</strong>，<strong>客户端也可以主动向服务器发送信息</strong>，是真正的<strong>双向平等对话</strong>，属于<a href="https://en.wikipedia.org/wiki/Push_technology" target="_blank" rel="noopener">服务器推送技术</a>的一种。</p>
<p>简单理解：</p>
<p>HTTP 打电话：</p>
<ul>
<li>我问一句</li>
<li>你回答一句</li>
<li>没有提问就没有回答，即便对方主动给你说话，我也是个聋子听不见</li>
</ul>
<p>WebSocket 打电话：</p>
<ul>
<li>双向对话</li>
</ul>
<p><img src="./assets/bg2017051502.png" alt="img"></p>
<blockquote>
<p>HTTP 和 WebSocket 通信模型</p>
</blockquote>
<p>其他特点包括：</p>
<p>（1）建立在 TCP 协议之上，服务器端的实现比较容易。</p>
<p>（2）与 HTTP 协议有着良好的兼容性。默认端口也是 80 和 443，并且握手阶段（第 1 次建立连接）采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。</p>
<p>（3）数据格式比较轻量，性能开销小，通信高效。</p>
<p>（4）可以发送文本，也可以发送二进制数据。</p>
<p>（5）没有同源跨域限制，客户端可以与任意服务器通信。</p>
<p>（6）协议标识符是<code>ws</code>（如果加密，则为<code>wss</code>），服务器网址就是 URL。</p>
<p>（7）浏览器专门为 WebSocket 通信提供了一个请求对象 <code>WebSocket</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ws:&#x2F;&#x2F;example.com:80&#x2F;some&#x2F;path</span><br></pre></td></tr></table></figure>

<p><img src="./assets/bg2017051503.jpg" alt="img"></p>
<h2 id="使用原生-WebSocket（了解）"><a href="#使用原生-WebSocket（了解）" class="headerlink" title="使用原生 WebSocket（了解）"></a>使用原生 WebSocket（了解）</h2><blockquote>
<p>参考文档：</p>
<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket" target="_blank" rel="noopener">MDN - WebSocket</a></li>
</ul>
</blockquote>
<p>浏览器为 HTTP 通信提供了 <code>XMLHttpRequest</code> 对象，同样的，也为 WebSocket 通信提供了一个通信操作接口：<code>WebSocket</code>。</p>
<p>通信模型：</p>
<ul>
<li>拨号（建立连接）</li>
<li>通话（双向通信）</li>
<li>结束通话（关闭连接）</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// WebSocet 通信模型</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 1. 拨打电话（建立连接）</span></span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 注意：wss://echo.websocket.org 是一个在线的测试接口，仅用于 WebSocket 协议通信测试使用</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"wss://echo.websocket.org"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 当连接建立成功，触发 open 事件</span></span></span><br><span class="line"><span class="actionscript">      ws.onopen = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">"建立连接成功 ..."</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// 连接建立成功以后，就可以使用这个连接对象通信了</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// send 方法发送数据</span></span></span><br><span class="line"><span class="actionscript">        ws.send(<span class="string">"Hello WebSockets!"</span>);</span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 当接收到对方发送的消息的时候，触发 message 事件</span></span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 我们可以通过回调函数的 evt.data 获取对方发送的数据内容</span></span></span><br><span class="line"><span class="actionscript">      ws.onmessage = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">"接收到消息: "</span> + evt.data);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// 当不需要通信的时候，可以手动的关闭连接</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// ws.close();</span></span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 当连接断开的时候触发 close 事件</span></span></span><br><span class="line"><span class="actionscript">      ws.onclose = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">"连接已关闭."</span>);</span></span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>怎么查看 WebSocket 请求日志：</p>
<p><img src="assets/1569575005360.png" alt="1569575005360"></p>
<blockquote>
<p>朝上的绿色箭头是发出去的消息</p>
<p>朝下的红色箭头是收到的消息</p>
</blockquote>
<h2 id="Socket-IO（了解体验）"><a href="#Socket-IO（了解体验）" class="headerlink" title="Socket.IO（了解体验）"></a>Socket.IO（了解体验）</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><ul>
<li>原生的 WebSocket 使用比较麻烦，所以推荐使用一个封装好的解决方案：socket.io</li>
<li>socket.io 提供了服务端 + 客户端的实现<ul>
<li>客户端：浏览器</li>
<li>服务端：Java、Python、PHP、。。。。Node.js</li>
</ul>
</li>
<li>对于前端开发者来说，只需要关心她的客户端如何使用即可</li>
<li>注意：Socket.io 必须前后端配套使用<ul>
<li>实际工作中，socket.io 已经成为了各大后端开发的 WebSocket 通信主流解决方案</li>
</ul>
</li>
<li><a href="https://github.com/socketio/socket.io" target="_blank" rel="noopener">GitHub 仓库</a></li>
<li><a href="https://socket.io/" target="_blank" rel="noopener">官网</a></li>
</ul>
<p>Socket.io 和 WebSocket 就好比它就好比 axios 和 XMLHTTPRequest 的关系。</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>官方的 Hello World：<a href="https://socket.io/get-started/chat/。" target="_blank" rel="noopener">https://socket.io/get-started/chat/。</a></p>
<p>服务端代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">"express"</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>).createServer(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">"socket.io"</span>)(http);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.sendFile(__dirname + <span class="string">"/index.html"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">io.on(<span class="string">"connection"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  socket.on(<span class="string">"disconnect"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"user disconnected"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  socket.on(<span class="string">"chat message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    io.emit(<span class="string">"chat message"</span>, msg);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.listen(<span class="number">3000</span>, <span class="string">"0.0.0.0"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"listening on *:3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>客户端代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">      * &#123;</span><br><span class="line">        margin: 0;</span><br><span class="line">        padding: 0;</span><br><span class="line">        box-sizing: border-box;</span><br><span class="line">      &#125;</span><br><span class="line">      body &#123;</span><br><span class="line">        font: 13px Helvetica, Arial;</span><br><span class="line">      &#125;</span><br><span class="line">      form &#123;</span><br><span class="line"><span class="css">        <span class="selector-tag">background</span>: <span class="selector-id">#000</span>;</span></span><br><span class="line">        padding: 3px;</span><br><span class="line">        position: fixed;</span><br><span class="line">        bottom: 0;</span><br><span class="line">        width: 100%;</span><br><span class="line">      &#125;</span><br><span class="line">      form input &#123;</span><br><span class="line">        border: 0;</span><br><span class="line">        padding: 10px;</span><br><span class="line">        width: 90%;</span><br><span class="line"><span class="css">        <span class="selector-tag">margin-right</span>: 0<span class="selector-class">.5</span>%;</span></span><br><span class="line">      &#125;</span><br><span class="line">      form button &#123;</span><br><span class="line">        width: 9%;</span><br><span class="line">        background: rgb(130, 224, 255);</span><br><span class="line">        border: none;</span><br><span class="line">        padding: 10px;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="css">      <span class="selector-id">#messages</span> &#123;</span></span><br><span class="line">        list-style-type: none;</span><br><span class="line">        margin: 0;</span><br><span class="line">        padding: 0;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="css">      <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line">        padding: 5px 10px;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="css">      <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child(odd)</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">background</span>: <span class="selector-id">#eee</span>;</span></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 消息列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"messages"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 发送消息的表单 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"m"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span> /&gt;</span><span class="tag">&lt;<span class="name">button</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- SocketIO 提供了一个客户端实现：socket.io.js --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/socket.io/socket.io.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-1.11.1.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 建立连接，得到 socket 通信对象</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> socket = io();</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      socket.on(<span class="string">"connect"</span>, () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">"建立连接成功了"</span>);</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line"><span class="javascript">      $(<span class="string">"form"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">        e.preventDefault(); <span class="comment">// prevents page reloading</span></span></span><br><span class="line"><span class="javascript">        socket.emit(<span class="string">"chat message"</span>, $(<span class="string">"#m"</span>).val());</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#m"</span>).val(<span class="string">""</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      socket.on(<span class="string">"chat message"</span>, <span class="function"><span class="keyword">function</span><span class="params">(msg)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#messages"</span>).append($(<span class="string">"&lt;li&gt;"</span>).text(msg));</span></span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="扩展：ngrok-代理"><a href="#扩展：ngrok-代理" class="headerlink" title="扩展：ngrok 代理"></a>扩展：ngrok 代理</h3><p><a href="https://lipengzhou.com/posts/9c28d833/" target="_blank" rel="noopener">https://lipengzhou.com/posts/9c28d833/</a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>我们只需要关注客户端怎么使用：</p>
<ul>
<li>怎么建立连接</li>
<li>怎么发送消息</li>
<li>怎么接收消息</li>
</ul>
<p>建立连接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socket = io(<span class="string">"连接地址"</span>);</span><br></pre></td></tr></table></figure>

<p>发送数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送指定类型的消息</span></span><br><span class="line"><span class="comment">// 数据可以是任何类型</span></span><br><span class="line">socket.emit(<span class="string">"消息类型"</span>, 数据);</span><br></pre></td></tr></table></figure>

<p>接收消息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消息类型</span></span><br><span class="line"><span class="comment">// 回调函数参数获取消息数据</span></span><br><span class="line">socket.on(<span class="string">"消息类型"</span>, data =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>消息类型由后端给出，他会告诉你收发消息的类型，就好比 HTTP 接口中的请求路径一样。</p>
</blockquote>
<h2 id="小智同学"><a href="#小智同学" class="headerlink" title="小智同学"></a>小智同学</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>创建 <code>chat/index.vue</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>小智同学<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">"ChatIndex"</span></span></span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后配置路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> Chat <span class="keyword">from</span> <span class="string">'@/views/chat'</span></span><br><span class="line"></span><br><span class="line">Vue.use(VueRouter)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">  <span class="comment">// 配置路由表</span></span><br><span class="line">  routes: [</span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'user-chat'</span>,</span><br><span class="line">      path: <span class="string">'/user/chat'</span>,</span><br><span class="line">      component: Chat</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>最后，在我的页面中点击 “小智同学” 跳转到聊天页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 其它 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">van-grid</span> <span class="attr">clickable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-grid-item</span> <span class="attr">icon</span>=<span class="string">"star"</span> <span class="attr">text</span>=<span class="string">"我的收藏"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-grid-item</span> <span class="attr">icon</span>=<span class="string">"chat"</span> <span class="attr">text</span>=<span class="string">"我的评论"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-grid-item</span> <span class="attr">icon</span>=<span class="string">"like"</span> <span class="attr">text</span>=<span class="string">"我的点赞"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-grid-item</span> <span class="attr">icon</span>=<span class="string">"browsing-history"</span> <span class="attr">text</span>=<span class="string">"浏览历史"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">van-grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">"消息通知"</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">"用户反馈"</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">  + <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">"小智同学"</span> <span class="attr">is-link</span> @<span class="attr">click</span>=<span class="string">"$router.push('/chat')"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">"系统设置"</span> <span class="attr">is-link</span> <span class="attr">to</span>=<span class="string">"/settings"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- /其它 --&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-container"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 导航栏 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-nav-bar</span></span></span><br><span class="line"><span class="tag">      <span class="attr">title</span>=<span class="string">"小智同学"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">left-arrow</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">click-left</span>=<span class="string">"$router.back()"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">fixed</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /导航栏 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 消息列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"message-list"</span> <span class="attr">ref</span>=<span class="string">"message-list"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"message-item"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:class</span>=<span class="string">"&#123; reverse: item % 3 === 0 &#125;"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">v-for</span>=<span class="string">"item in 20"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:key</span>=<span class="string">"item"</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-image</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"avatar"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">slot</span>=<span class="string">"icon"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">round</span></span></span><br><span class="line"><span class="tag">          <span class="attr">width</span>=<span class="string">"30"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">height</span>=<span class="string">"30"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">src</span>=<span class="string">"https://img.yzcdn.cn/vant/cat.jpeg"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; `hello$&#123;item&#125;` &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /消息列表 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 发送消息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">class</span>=<span class="string">"send-message"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">v-model</span>=<span class="string">"message"</span> <span class="attr">center</span> <span class="attr">clearable</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-button</span> <span class="attr">slot</span>=<span class="string">"button"</span> <span class="attr">size</span>=<span class="string">"small"</span> <span class="attr">type</span>=<span class="string">"primary"</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">van-button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /发送消息 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    data() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        message: <span class="string">""</span></span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    mounted() &#123;</span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.list = <span class="keyword">this</span>.$refs[<span class="string">"message-list"</span>];</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span> <span class="attr">lang</span>=<span class="string">"less"</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.chat-container</span> &#123;</span></span><br><span class="line">    position: absolute;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    padding: 46px 0 50px 0;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-id">#f5f5f6</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.message-list</span> &#123;</span></span><br><span class="line">      height: 100%;</span><br><span class="line">      overflow-y: scroll;</span><br><span class="line"><span class="css">      <span class="selector-class">.message-item</span> &#123;</span></span><br><span class="line">        display: flex;</span><br><span class="line">        align-items: center;</span><br><span class="line">        padding: 10px;</span><br><span class="line"><span class="css">        <span class="selector-class">.title</span> &#123;</span></span><br><span class="line"><span class="css">          <span class="selector-tag">background</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">          padding: 5px;</span><br><span class="line">          border-radius: 6px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.avatar</span> &#123;</span></span><br><span class="line">          margin-right: 5px;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="css">      <span class="selector-class">.reverse</span> &#123;</span></span><br><span class="line">        flex-direction: row-reverse;</span><br><span class="line"><span class="css">        <span class="selector-class">.title</span> &#123;</span></span><br><span class="line">          margin-right: 5px;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-class">.send-message</span> &#123;</span></span><br><span class="line">      position: fixed;</span><br><span class="line">      bottom: 0;</span><br><span class="line">      left: 0;</span><br><span class="line">      right: 0;</span><br><span class="line"><span class="css">      <span class="selector-tag">background</span>: <span class="selector-id">#f5f5f6</span> !<span class="selector-tag">important</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"page-user-chat"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-nav-bar</span></span></span><br><span class="line"><span class="tag">      <span class="attr">fixed</span></span></span><br><span class="line"><span class="tag">      <span class="attr">left-arrow</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">click-left</span>=<span class="string">"$router.back()"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">title</span>=<span class="string">"小智同学"</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;/<span class="name">van-nav-bar</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-list"</span> <span class="attr">ref</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"chat-item"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:class</span>=<span class="string">"&#123;left:item.name==='xz',right:item.name==='self'&#125;"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">v-for</span>=<span class="string">"(item,i) in list"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:key</span>=<span class="string">"i"</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-image</span> <span class="attr">v-if</span>=<span class="string">"item.name==='xz'"</span> <span class="attr">fit</span>=<span class="string">"cover"</span> <span class="attr">round</span> <span class="attr">:src</span>=<span class="string">"xzAvatar"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-pao"</span>&gt;</span>&#123;&#123;item.msg&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-image</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-if</span>=<span class="string">"item.name==='self'"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">fit</span>=<span class="string">"cover"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">round</span></span></span><br><span class="line"><span class="tag">          <span class="attr">src</span>=<span class="string">"https://img.yzcdn.cn/vant/cat.jpeg"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"reply-container van-hairline--top"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">v-model</span>=<span class="string">"value"</span> <span class="attr">placeholder</span>=<span class="string">"说点什么..."</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-loading</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-if</span>=<span class="string">"commentLoading"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">slot</span>=<span class="string">"button"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"spinner"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">size</span>=<span class="string">"16px"</span></span></span><br><span class="line"><span class="tag">        &gt;</span><span class="tag">&lt;/<span class="name">van-loading</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-else</span></span></span><br><span class="line"><span class="tag">          @<span class="attr">click</span>=<span class="string">"send()"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">slot</span>=<span class="string">"button"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">style</span>=<span class="string">"font-size:12px;color:#999"</span></span></span><br><span class="line"><span class="tag">          &gt;</span>提交<span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> xzAvatar <span class="keyword">from</span> <span class="string">"@/assets/images/xz.png"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">"socket.io-client"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123; userLocal &#125; <span class="keyword">from</span> <span class="string">"@/utils/local"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    data() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        value: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">        list: <span class="literal">null</span>,</span></span><br><span class="line">        xzAvatar,</span><br><span class="line"><span class="actionscript">        commentLoading: <span class="literal">false</span></span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    created() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.list = [];</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.socket = io(<span class="string">"http://ttapi.research.itcast.cn"</span>, &#123;</span></span><br><span class="line">        query: &#123;</span><br><span class="line">          token: userLocal.getUser().token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.socket.on(<span class="string">"connect"</span>, () =&gt; &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 建了链接后默认  小智给你打招呼</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.list.push(&#123; name: <span class="string">"xz"</span>, msg: <span class="string">"你好"</span> &#125;);</span></span><br><span class="line">      &#125;);</span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.socket.on(<span class="string">"message"</span>, data =&gt; &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 接受机器人消息</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.list.push(&#123; name: <span class="string">"xz"</span>, msg: data.msg &#125;);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.scrollBottom();</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    deactivated() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.socket.close();</span></span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">      scrollBottom() &#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">this</span>.$refs.list.scrollTop = <span class="keyword">this</span>.$refs.list.scrollHeight;</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      send() &#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.socket.emit(<span class="string">"message"</span>, &#123; <span class="attr">msg</span>: <span class="keyword">this</span>.value, <span class="attr">timestamp</span>: <span class="built_in">Date</span>.now() &#125;);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.list.push(&#123; name: <span class="string">"self"</span>, msg: <span class="keyword">this</span>.value &#125;);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.value = <span class="string">""</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.scrollBottom();</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span> <span class="attr">lang</span>=<span class="string">"less"</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.page-user-chat</span> &#123;</span></span><br><span class="line">    height: 100%;</span><br><span class="line">    width: 100%;</span><br><span class="line">    position: absolute;</span><br><span class="line">    left: 0;</span><br><span class="line">    top: 0;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line">    padding: 46px 0 50px 0;</span><br><span class="line"><span class="css">    <span class="selector-class">.chat-list</span> &#123;</span></span><br><span class="line">      height: 100%;</span><br><span class="line">      overflow-y: scroll;</span><br><span class="line"><span class="css">      <span class="selector-class">.chat-item</span> &#123;</span></span><br><span class="line">        padding: 10px;</span><br><span class="line"><span class="css">        <span class="selector-class">.van-image</span> &#123;</span></span><br><span class="line">          vertical-align: top;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.chat-pao</span> &#123;</span></span><br><span class="line">          vertical-align: top;</span><br><span class="line">          display: inline-block;</span><br><span class="line">          min-width: 20px;</span><br><span class="line">          max-width: 60%;</span><br><span class="line">          min-height: 40px;</span><br><span class="line">          line-height: 40px;</span><br><span class="line"><span class="css">          <span class="selector-tag">border</span>: 0<span class="selector-class">.5px</span> <span class="selector-tag">solid</span> <span class="selector-id">#c2d9ea</span>;</span></span><br><span class="line">          border-radius: 4px;</span><br><span class="line">          position: relative;</span><br><span class="line">          padding: 0 10px;</span><br><span class="line"><span class="css">          <span class="selector-tag">background-color</span>: <span class="selector-id">#e0effb</span>;</span></span><br><span class="line">          word-break: break-all;</span><br><span class="line">          font-size: 14px;</span><br><span class="line"><span class="css">          <span class="selector-tag">color</span>: <span class="selector-id">#333</span>;</span></span><br><span class="line"><span class="css">          &amp;<span class="selector-pseudo">::before</span> &#123;</span></span><br><span class="line">            content: "";</span><br><span class="line">            width: 10px;</span><br><span class="line">            height: 10px;</span><br><span class="line">            position: absolute;</span><br><span class="line">            top: 13px;</span><br><span class="line"><span class="css">            <span class="selector-tag">border-top</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#c2d9ea</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border-right</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#c2d9ea</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#e0effb</span>;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="css">  <span class="selector-class">.chat-item</span><span class="selector-class">.right</span> &#123;</span></span><br><span class="line">    text-align: right;</span><br><span class="line"><span class="css">    <span class="selector-class">.chat-pao</span> &#123;</span></span><br><span class="line">      margin-left: 0;</span><br><span class="line">      margin-right: 15px;</span><br><span class="line"><span class="css">      &amp;<span class="selector-pseudo">::before</span> &#123;</span></span><br><span class="line">        right: -6px;</span><br><span class="line">        transform: rotate(45deg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="css">  <span class="selector-class">.chat-item</span><span class="selector-class">.left</span> &#123;</span></span><br><span class="line">    text-align: left;</span><br><span class="line"><span class="css">    <span class="selector-class">.chat-pao</span> &#123;</span></span><br><span class="line">      margin-left: 15px;</span><br><span class="line">      margin-right: 0;</span><br><span class="line"><span class="css">      &amp;<span class="selector-pseudo">::before</span> &#123;</span></span><br><span class="line">        left: -6px;</span><br><span class="line">        transform: rotate(-135deg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="css">  <span class="selector-class">.van-image</span> &#123;</span></span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="css">  <span class="selector-class">.reply-container</span> &#123;</span></span><br><span class="line">    position: fixed;</span><br><span class="line">    left: 0;</span><br><span class="line">    bottom: 0;</span><br><span class="line">    height: 44px;</span><br><span class="line">    width: 100%;</span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-id">#f5f5f5</span>;</span></span><br><span class="line">    z-index: 9999;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>步骤：</p>
<ul>
<li>安装<ul>
<li><a href="https://github.com/socketio/socket.io-client" target="_blank" rel="noopener">https://github.com/socketio/socket.io-client</a></li>
</ul>
</li>
<li>导入</li>
<li>建立连接</li>
</ul>
<p>1、安装依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yarn add socket.io-client</span></span><br><span class="line">npm i socket.io-client</span><br></pre></td></tr></table></figure>

<p>2、在初始化的时候建立连接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">"socket.io-client"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">""</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="comment">// 建立连接</span></span><br><span class="line">    <span class="keyword">const</span> socket = io(<span class="string">"http://ttapi.research.itcast.cn"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当客户端与服务器建立连接成功，触发 connect 事件</span></span><br><span class="line">    socket.on(<span class="string">"connect"</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"建立连接成功！"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="收发消息"><a href="#收发消息" class="headerlink" title="收发消息"></a>收发消息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">'socket.io-client'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">''</span>,</span><br><span class="line">+      socket: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="comment">// 建立连接</span></span><br><span class="line">    <span class="keyword">const</span> socket = io(<span class="string">'http://ttapi.research.itcast.cn'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把 socket 存储到 data 中，然后就可以在 methods 中访问到了</span></span><br><span class="line">+    <span class="keyword">this</span>.socket = socket</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当客户端与服务器建立连接成功，触发 connect 事件</span></span><br><span class="line">    socket.on(<span class="string">'connect'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'建立连接成功！'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听接收服务端消息</span></span><br><span class="line">+    socket.on(<span class="string">'message'</span>, data =&gt; &#123;</span><br><span class="line">+      <span class="built_in">console</span>.log(<span class="string">'收到服务器消息：'</span>, data)</span><br><span class="line">+    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">+    onSendMessage () &#123;</span><br><span class="line">+      <span class="keyword">const</span> message = <span class="keyword">this</span>.message.trim()</span><br><span class="line">+      <span class="keyword">if</span> (!message) &#123;</span><br><span class="line">+        <span class="keyword">return</span></span><br><span class="line">+      &#125;</span><br><span class="line">+</span><br><span class="line">+      <span class="comment">// 发送消息</span></span><br><span class="line">+      <span class="keyword">this</span>.socket.emit(<span class="string">'message'</span>, &#123;</span><br><span class="line">+        msg: message,</span><br><span class="line">+        timestamp: <span class="built_in">Date</span>.now()</span><br><span class="line">+      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="展示消息列表"><a href="#展示消息列表" class="headerlink" title="展示消息列表"></a>展示消息列表</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-container"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 导航栏 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-nav-bar</span></span></span><br><span class="line"><span class="tag">      <span class="attr">title</span>=<span class="string">"小智同学"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">left-arrow</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">click-left</span>=<span class="string">"$router.back()"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">fixed</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /导航栏 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 消息列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"message-list"</span> <span class="attr">ref</span>=<span class="string">"message-list"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"message-item"</span></span></span><br><span class="line"><span class="tag">        +</span></span><br><span class="line"><span class="tag">        <span class="attr">:class</span>=<span class="string">"&#123; reverse: item.isMe &#125;"</span></span></span><br><span class="line"><span class="tag">        +</span></span><br><span class="line"><span class="tag">        <span class="attr">v-for</span>=<span class="string">"(item, index) in messages"</span></span></span><br><span class="line"><span class="tag">        +</span></span><br><span class="line"><span class="tag">        <span class="attr">:key</span>=<span class="string">"index"</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-image</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"avatar"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">slot</span>=<span class="string">"icon"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">round</span></span></span><br><span class="line"><span class="tag">          <span class="attr">width</span>=<span class="string">"30"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">height</span>=<span class="string">"30"</span></span></span><br><span class="line"><span class="tag">          +</span></span><br><span class="line"><span class="tag">          <span class="attr">:src</span>=<span class="string">"item.photo"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>+ <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.message &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /消息列表 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 发送消息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">class</span>=<span class="string">"send-message"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">v-model</span>=<span class="string">"message"</span> <span class="attr">center</span> <span class="attr">clearable</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-button</span></span></span><br><span class="line"><span class="tag">          <span class="attr">slot</span>=<span class="string">"button"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">size</span>=<span class="string">"small"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"primary"</span></span></span><br><span class="line"><span class="tag">          @<span class="attr">click</span>=<span class="string">"onSendMessage"</span></span></span><br><span class="line"><span class="tag">          &gt;</span>发送<span class="tag">&lt;/<span class="name">van-button</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /发送消息 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">'socket.io-client'</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">'ChatIndex'</span>,</span></span><br><span class="line">    data () &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        message: <span class="string">''</span>,</span></span><br><span class="line"><span class="actionscript">        socket: <span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// [ &#123; message: '消息数据', isMe: true, photo: '头像' &#125;, ]</span></span></span><br><span class="line"><span class="actionscript">  +      messages: [] <span class="comment">// 存储所有的消息列表</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    created () &#123;</span><br><span class="line"><span class="actionscript">      <span class="comment">// 建立连接</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">const</span> socket = io(<span class="string">'http://ttapi.research.itcast.cn'</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 把 socket 存储到 data 中，然后就可以在 methods 中访问到了</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.socket = socket</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 当客户端与服务器建立连接成功，触发 connect 事件</span></span></span><br><span class="line"><span class="actionscript">      socket.on(<span class="string">'connect'</span>, () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'建立连接成功！'</span>)</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 监听接收服务端消息</span></span></span><br><span class="line"><span class="actionscript">      socket.on(<span class="string">'message'</span>, data =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'收到服务器消息：'</span>, data)</span></span><br><span class="line"><span class="actionscript">  +      <span class="keyword">this</span>.messages.push(&#123;</span></span><br><span class="line">  +        message: data.msg,</span><br><span class="line"><span class="actionscript">  +        isMe: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">  +        photo: <span class="string">'http://toutiao.meiduo.site/FkBUsGwtrHKjoF0NPLzeilckol1-'</span></span></span><br><span class="line">  +      &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    methods: &#123;</span><br><span class="line">      onSendMessage () &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">const</span> message = <span class="keyword">this</span>.message.trim()</span></span><br><span class="line">        if (!message) &#123;</span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// 发送消息</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.socket.emit(<span class="string">'message'</span>, &#123;</span></span><br><span class="line">          msg: message,</span><br><span class="line"><span class="javascript">          timestamp: <span class="built_in">Date</span>.now()</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// 把消息存储到数组中</span></span></span><br><span class="line"><span class="actionscript">  +      <span class="keyword">this</span>.messages.push(&#123;</span></span><br><span class="line">  +        message,</span><br><span class="line"><span class="actionscript">  +        isMe: <span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">  +        photo: <span class="string">'https://img.yzcdn.cn/vant/cat.jpeg'</span></span></span><br><span class="line">  +      &#125;)</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// 清空文本框</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.message = <span class="string">''</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">'socket.io-client'</span></span><br><span class="line">+ <span class="keyword">import</span> &#123; getItem, setItem &#125; <span class="keyword">from</span> <span class="string">'@/utils/storage'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'ChatIndex'</span>,</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">''</span>,</span><br><span class="line">      socket: <span class="literal">null</span>,</span><br><span class="line">      <span class="comment">// [ &#123; message: '消息数据', isMe: true, photo: '头像' &#125;, ]</span></span><br><span class="line">+      messages: getItem(<span class="string">'chat-messages'</span>) || []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">+  watch: &#123;</span><br><span class="line">+    messages (newValue) &#123;</span><br><span class="line">+      setItem(<span class="string">'chat-messages'</span>, newValue)</span><br><span class="line">+    &#125;</span><br><span class="line">+  &#125;,</span><br><span class="line"></span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="comment">// 建立连接</span></span><br><span class="line">    <span class="keyword">const</span> socket = io(<span class="string">'http://ttapi.research.itcast.cn'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把 socket 存储到 data 中，然后就可以在 methods 中访问到了</span></span><br><span class="line">    <span class="keyword">this</span>.socket = socket</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当客户端与服务器建立连接成功，触发 connect 事件</span></span><br><span class="line">    socket.on(<span class="string">'connect'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'建立连接成功！'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听接收服务端消息</span></span><br><span class="line">    socket.on(<span class="string">'message'</span>, data =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'收到服务器消息：'</span>, data)</span><br><span class="line">      <span class="keyword">this</span>.messages.push(&#123;</span><br><span class="line">        message: data.msg,</span><br><span class="line">        isMe: <span class="literal">false</span>,</span><br><span class="line">        photo: <span class="string">'http://toutiao.meiduo.site/FkBUsGwtrHKjoF0NPLzeilckol1-'</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    onSendMessage () &#123;</span><br><span class="line">      <span class="keyword">const</span> message = <span class="keyword">this</span>.message.trim()</span><br><span class="line">      <span class="keyword">if</span> (!message) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 发送消息</span></span><br><span class="line">      <span class="keyword">this</span>.socket.emit(<span class="string">'message'</span>, &#123;</span><br><span class="line">        msg: message,</span><br><span class="line">        timestamp: <span class="built_in">Date</span>.now()</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 把消息存储到数组中</span></span><br><span class="line">      <span class="keyword">this</span>.messages.push(&#123;</span><br><span class="line">        message,</span><br><span class="line">        isMe: <span class="literal">true</span>,</span><br><span class="line">        photo: <span class="string">'https://img.yzcdn.cn/vant/cat.jpeg'</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 清空文本框</span></span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消息列表自动滚动到底部"><a href="#消息列表自动滚动到底部" class="headerlink" title="消息列表自动滚动到底部"></a>消息列表自动滚动到底部</h3><p>公式：DOM.scrollTop = DOM.scrollHeight</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">'socket.io-client'</span></span><br><span class="line"><span class="keyword">import</span> &#123; getItem, setItem &#125; <span class="keyword">from</span> <span class="string">'@/utils/storage'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'ChatIndex'</span>,</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">''</span>,</span><br><span class="line">      socket: <span class="literal">null</span>,</span><br><span class="line">      <span class="comment">// [ &#123; message: '消息数据', isMe: true, photo: '头像' &#125;, ]</span></span><br><span class="line">      messages: getItem(<span class="string">'chat-messages'</span>) || []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  watch: &#123;</span><br><span class="line">    messages (newValue) &#123;</span><br><span class="line">      setItem(<span class="string">'chat-messages'</span>, newValue)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 让列表滚动到最底部</span></span><br><span class="line">+      <span class="keyword">const</span> messageList = <span class="keyword">this</span>.$refs[<span class="string">'message-list'</span>]</span><br><span class="line">+</span><br><span class="line">+      <span class="comment">// 这里需要把操作 DOM 的这个代码放到 $nextTick 中</span></span><br><span class="line">+      <span class="comment">// 为啥？明天再说</span></span><br><span class="line">+      <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">+        messageList.scrollTop = messageList.scrollHeight</span><br><span class="line">+      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="comment">// 建立连接</span></span><br><span class="line">    <span class="keyword">const</span> socket = io(<span class="string">'http://ttapi.research.itcast.cn'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把 socket 存储到 data 中，然后就可以在 methods 中访问到了</span></span><br><span class="line">    <span class="keyword">this</span>.socket = socket</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当客户端与服务器建立连接成功，触发 connect 事件</span></span><br><span class="line">    socket.on(<span class="string">'connect'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'建立连接成功！'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听接收服务端消息</span></span><br><span class="line">    socket.on(<span class="string">'message'</span>, data =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'收到服务器消息：'</span>, data)</span><br><span class="line">      <span class="keyword">this</span>.messages.push(&#123;</span><br><span class="line">        message: data.msg,</span><br><span class="line">        isMe: <span class="literal">false</span>,</span><br><span class="line">        photo: <span class="string">'http://toutiao.meiduo.site/FkBUsGwtrHKjoF0NPLzeilckol1-'</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">+  mounted () &#123;</span><br><span class="line">+    <span class="keyword">const</span> messageList = <span class="keyword">this</span>.$refs[<span class="string">'message-list'</span>]</span><br><span class="line">+    messageList.scrollTop = messageList.scrollHeight</span><br><span class="line">+  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    onSendMessage () &#123;</span><br><span class="line">      <span class="keyword">const</span> message = <span class="keyword">this</span>.message.trim()</span><br><span class="line">      <span class="keyword">if</span> (!message) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 发送消息</span></span><br><span class="line">      <span class="keyword">this</span>.socket.emit(<span class="string">'message'</span>, &#123;</span><br><span class="line">        msg: message,</span><br><span class="line">        timestamp: <span class="built_in">Date</span>.now()</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 把消息存储到数组中</span></span><br><span class="line">      <span class="keyword">this</span>.messages.push(&#123;</span><br><span class="line">        message,</span><br><span class="line">        isMe: <span class="literal">true</span>,</span><br><span class="line">        photo: <span class="string">'https://img.yzcdn.cn/vant/cat.jpeg'</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 清空文本框</span></span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="nextTick-的作用"><a href="#nextTick-的作用" class="headerlink" title="$nextTick 的作用"></a>$nextTick 的作用</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h1</span> <span class="attr">ref</span>=<span class="string">"message"</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"changeMessage"</span>&gt;</span>点击改变 message<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cn.vuejs.org/js/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">		<span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="actionscript">			el: <span class="string">'#app'</span>,</span></span><br><span class="line">			data: &#123;</span><br><span class="line"><span class="actionscript">				message: <span class="string">'hello'</span></span></span><br><span class="line">			&#125;,</span><br><span class="line">			methods: &#123;</span><br><span class="line">				changeMessage () &#123;</span><br><span class="line"><span class="actionscript">					<span class="comment">// 修改数据（响应式），数据改变会影响视图更新</span></span></span><br><span class="line"><span class="actionscript">					<span class="comment">// 注意：数据影响视图不是即时的</span></span></span><br><span class="line"><span class="actionscript">					<span class="keyword">this</span>.message = <span class="string">'world'</span></span></span><br><span class="line">					</span><br><span class="line"><span class="actionscript">					<span class="keyword">this</span>.hello()</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">					<span class="comment">// 修改完数据之后，马上操作数据影响的这个 DOM</span></span></span><br><span class="line"><span class="actionscript">					<span class="comment">// console.log(this.$refs.message.innerHTML)</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">					<span class="comment">// 什么场景下才需要使用这个 API？当你想要在修改数据之后马上操作数据影响的DOM。</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">					<span class="comment">// 为了解决这个问题，Vue 提供了一个特殊的 API：$nextTick</span></span></span><br><span class="line"><span class="actionscript">					<span class="comment">// 该函数中的代码会确保本次数据更新视图之后才执行</span></span></span><br><span class="line"><span class="actionscript">					<span class="comment">// 官方文档说明：https://cn.vuejs.org/v2/api/#vm-nextTick</span></span></span><br><span class="line"><span class="actionscript">					<span class="comment">// 该代码不是更新视图 DOM，更新视图 DOM 是 Vue 的事儿</span></span></span><br><span class="line"><span class="actionscript">					<span class="comment">// 简单理解：你可以把它当作一个定时器，它会在内部完成 DOM 修改之后触发调用</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="built_in">console</span>.log(<span class="keyword">this</span>.$refs.message.innerHTML)</span></span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;,</span><br><span class="line"></span><br><span class="line">				hello () &#123;</span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="keyword">this</span>.$refs.message.innerHTML)</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


                <hr>
                

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2020/04/06/移动项目/14-功能优化/" data-toggle="tooltip" data-placement="top"
                           title="移动项目/14-功能优化">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2020/04/06/移动项目/12-我的收藏-历史-作品/" data-toggle="tooltip" data-placement="top"
                           title="移动项目/12-我的收藏-历史-作品">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                


                <!--加入新的评论系统-->
                

                

            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#十三、小智同学"><span class="toc-text">十三、小智同学</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket"><span class="toc-text">WebSocket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用原生-WebSocket（了解）"><span class="toc-text">使用原生 WebSocket（了解）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Socket-IO（了解体验）"><span class="toc-text">Socket.IO（了解体验）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#介绍"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本使用"><span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩展：ngrok-代理"><span class="toc-text">扩展：ngrok 代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小智同学"><span class="toc-text">小智同学</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备"><span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#布局"><span class="toc-text">布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#建立连接"><span class="toc-text">建立连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#收发消息"><span class="toc-text">收发消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#展示消息列表"><span class="toc-text">展示消息列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据持久化"><span class="toc-text">数据持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息列表自动滚动到底部"><span class="toc-text">消息列表自动滚动到底部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nextTick-的作用"><span class="toc-text">$nextTick 的作用</span></a></li></ol></li></ol></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
            </div>
        </div>

    </div>
</article>







<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 测试顺带笔记 2020
                    <br>
                    <span id="busuanzi_container_site_pv" style="font-size: 12px;">PV: <span id="busuanzi_value_site_pv"></span> Times</span>
                    <br>
                    Theme by <a href="https://haojen.github.io/" target="_blank" rel="noopener">Haojen Ma</a>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/blog.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://yoursite.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>



<!-- Google Analytics -->



<!-- Baidu Tongji -->


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','','2.0.0');
</script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="">
</body>

</html>
